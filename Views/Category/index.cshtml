@using MyMvcApp.Models.DTOs

@{
    ViewData["Title"] = "Categories";
    Layout = "_Layout";
}

@section Styles {
    <style>
        .table tbody tr td a {
            background: #dfdfdf;
            border-radius: 5px;
        }
        .edit-delete-action a:hover {
            border-radius: 5px;
        }
        .table tbody tr td a:hover {
            color: #ffffff;
        }
        .table tbody tr td a:hover i {
            color: #ffffff;
        }
        .dataTables_info {
            margin-top: 0px;
            padding-bottom: 0px;
        }
        .dataTables_paginate .pagination li.previous.disabled {
            width: 40px;
        }
        .dataTables_paginate .pagination li.next.disabled {
            width: 22px;
        }
        .table td {
            padding: 0px;
        }
        div.dataTables_wrapper div.dataTables_info {
            padding-top: 10px;
        }
        .dataTables_length, .dataTables_paginate {
            margin-top: 5px !important;
        }
        div.dataTables_wrapper div.dataTables_filter {
            text-align: right;
            margin-bottom: 6px;
        }
    </style>
}
<div class="page-header">
    <div class="add-item d-flex">
        <div class="page-title">
            <h4>Category</h4>
            <h6>Manage your categories</h6>
        </div>
    </div>
    <ul class="table-top-head">
        <li>
            <a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf"><img src="https://dreamspos.dreamstechnologies.com/html/template/assets/img/icons/pdf.svg" alt="img"></a>
        </li>
        <li>
            <a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel"><img src="https://dreamspos.dreamstechnologies.com/html/template/assets/img/icons/excel.svg" alt="img"></a>
        </li>
        <li>
            <a data-bs-toggle="tooltip" data-bs-placement="top" title="Print"><i data-feather="printer" class="feather-rotate-ccw"></i></a>
        </li>
        <li>
            <a class="refresh" data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i data-feather="rotate-ccw" class="feather-rotate-ccw"></i></a>
        </li>
        <li>
            <a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i data-feather="chevron-up" class="feather-chevron-up"></i></a>
        </li>
    </ul>
    <div class="page-btn">
        <a href="#" class="btn btn-added" data-bs-toggle="modal" data-bs-target="#add-category"><i data-feather="plus-circle" class="me-2"></i>Add New Category</a>
    </div>
    </div>
    <!-- /product list -->
    <div class="card table-list-card">
    <div class="card-body">
        <div class="table-top">
            <div class="search-set">
                <div class="search-input">
                    <a href="#" class="btn btn-searchset"><i data-feather="search" class="feather-search"></i></a>
                </div>
            </div>
            <div class="search-path">
                <a class="btn btn-filter" id="filter_search">
                    <i data-feather="filter" class="filter-icon"></i>
                    <span><img src="https://dreamspos.dreamstechnologies.com/html/template/assets/img/icons/closes.svg" alt="img"></span>
                </a>
            </div>
            <div class="form-sort">
                <i data-feather="sliders" class="info-img"></i>
                <select class="select">
                    <option>Sort by Date</option>
                    <option>Newest</option>
                    <option>Oldest</option>
                </select>
            </div>
        </div>
        <!-- /Filter -->
        <div class="card" id="filter_inputs">
            <div class="card-body pb-0">
                <div class="row">
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="input-blocks">
                            <i data-feather="zap" class="info-img"></i>
                            <select class="select">
                                <option>Choose Category</option>
                                <option>Laptop</option>
                                <option>Electronics</option>
                                <option>Shoe</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="input-blocks">
                            <i data-feather="calendar" class="info-img"></i>
                            <div class="input-groupicon">
                                <input type="text" class="datetimepicker" placeholder="Choose Date" >
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="input-blocks">
                            <i data-feather="stop-circle" class="info-img"></i>
                            <select class="select">
                                <option>Choose Status</option>
                                <option>Active</option>
                                <option>Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12 ms-auto">
                        <div class="input-blocks">
                            <a class="btn btn-filters ms-auto"> <i data-feather="search" class="feather-search"></i> Search </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Filter -->
        <div class="table-responsive">
            <table class="table datanew">
                <thead>
                    <tr>
                        <th class="no-sort" name="Id">
                            <label class="checkboxs">
                                <input type="checkbox" id="select-all">
                                <span class="checkmarks"></span>
                            </label>
                        </th>
                        <th name="Name">Category</th>
                        <th name="Slug">Category slug</th>
                        <th name="CreatedAt">Created At</th>
                        <th name="Status">Status</th>
                        <th class="no-sort action-table-data">Action</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
<!-- /product list -->
<!-- Add Category -->
@await Html.PartialAsync("_CategoryForm", new CreateCategoryDto())
<!-- /Add Category -->

<!-- Edit Category -->
@await Html.PartialAsync("_EditCategoryForm", new UpdateCategoryDto())
<!-- /Edit Category -->

@section Scripts { 
    <partial name="_ValidationScriptsPartial" /> 
    <script> 
        $(document).ready(function () {
            var table = $('.datanew').DataTable();
            if ( $.fn.DataTable.isDataTable('.datanew') ) {
                table.destroy();
            }
            table = $('.datanew').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/categories/list',
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                },
                columns: [
                    { data: 'id', orderable: false, searchable: false,
                        render: function(data) {
                            return `<input type='checkbox' class='row-checkbox' value='${data}'>`;
                        }
                    },
                    { data: 'name' },
                    { data: 'slug' },
                    { data: 'createdAt' },
                    { data: 'status' },
                    { data: 'actions', orderable: false, searchable: false }
                ],
                order: [[3, 'desc']],
                lengthMenu: [10, 25, 50],
                responsive: true
            });

            $('.search-input input').on('keyup', function () {
                table.search(this.value).draw();
            });
            $('.refresh').on('click', function () {
                table.ajax.reload();
            });
            
            $('.category-name').on('input', function () { 
                var slug = $(this).val().toLowerCase().replace(/\s+/g, '-'); 
                $('.category-slug').val(slug).prop('readonly', true); 
            });

            $('#create-category-form').submit(function (e) {
                e.preventDefault();

                $('.text-danger').remove();
                $('.is-invalid').removeClass('is-invalid');

                if ($(this).valid()) {
                    $.ajax({
                        url: $(this).attr('action'),
                        type: $(this).attr('method'),
                        data: new FormData(this),
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success',
                                    text: response.message
                                });
                                $('#add-category').modal('hide');
                                $('#create-category-form')[0].reset();
                                table.ajax.reload();
                            } else {
                                if (response.errors) {
                                    $.each(response.errors, function (field, messages) {
                                        var input = $('[name="' + field + '"]');
                                        input.addClass('is-invalid');
                                        input.siblings('.text-danger').remove();

                                        $.each(messages, function (index, message) {
                                            input.after('<span class="text-danger">' + message + '</span>');
                                        });
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: response.message
                                    });
                                }
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Something went wrong. Please try again.'
                            });
                        }
                    });
                }
            });
            $('.datanew').on('click', '.btn-edit', function () {
                var categoryId = $(this).data('id');
                console.log("Clicked category ID:", categoryId);

                $.ajax({
                    url: '/categories/edit/' + categoryId,
                    type: 'GET',
                    success: function (data) {
                        if (data) {
                            console.log("Category data:", data);
                            $('#edit-category-form').attr('action', '/categories/edit/' + categoryId);

                            // hidden Id field (important for model binding)
                            $('#edit-category-form input[name="Id"]').val(data.id);

                            // fill fields
                            $('#edit-category-form input[name="Name"]').val(data.name);
                            $('#edit-category-form input[name="Slug"]').val(data.slug);
                            $('#edit-category-form textarea[name="Description"]').val(data.description);
                            // clear previous image preview
                            $('#edit-image-preview').remove();
                            $('#edit-category-form input[name="ImageFile"]').val('');
                            
                            // check status
                            $('#edit-category-form input[name="IsActive"]').prop('checked', data.isActive);

                            // preview image if exists
                            if (data.imageUrl) {
                                if ($('#edit-image-preview').length === 0) {
                                    $('<img>', {
                                        id: 'edit-image-preview',
                                        src: data.imageUrl,
                                        class: 'img-thumbnail mt-2',
                                        width: 120
                                    }).insertAfter('#edit-category-form input[name="ImageFile"]');
                                } else {
                                    $('#edit-image-preview').attr('src', data.imageUrl);
                                }
                            }

                            // finally open modal
                            $('#edit-category').modal('show');
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Category not found.'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Could not retrieve category details.'
                        });
                    }
                });
            });
        }); 
    </script> 
}
